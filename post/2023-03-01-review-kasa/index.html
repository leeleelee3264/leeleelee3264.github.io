<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.102.3" />


<link rel="shortcut icon" href="https://raw.githubusercontent.com/leeleelee3264/twitter_project/master/favicon.ico" />



<title>[General] Kasa에서 백엔드 엔지니어로서의 1년 회고하기 - leelee.log</title>


<meta name="author" content="leeleelee3264" />


<meta name="description" content="Kasa에서 1년 동안 백엔드 엔지니어로서 지낸 시간을 회고합니다." />


<meta name="keywords" content="General" />


<meta property="og:title" content="[General] Kasa에서 백엔드 엔지니어로서의 1년 회고하기" />
<meta name="twitter:title" content="[General] Kasa에서 백엔드 엔지니어로서의 1년 회고하기" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leeleelee3264.github.io/post/2023-03-01-review-kasa/" /><meta property="og:description" content="Kasa에서 1년 동안 백엔드 엔지니어로서 지낸 시간을 회고합니다." />
<meta name="twitter:description" content="Kasa에서 1년 동안 백엔드 엔지니어로서 지낸 시간을 회고합니다." /><meta property="og:image" content="https://leeleelee3264.github.io/static/img/og.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://leeleelee3264.github.io/static/img/og.png" /><meta property="article:published_time" content="2023-02-24T00:00:00+00:00" /><meta property="article:modified_time" content="2023-02-24T00:00:00+00:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://leeleelee3264.github.io/assets/css/fuji.min.b4a21b5d3eb1d0a51297e31230a65fc25e387843e45ec3a2d9176cd8d163c216d99b9b13a618b28f537c3b559ec8a408183b0fbfad48daddb9befa7d3ef90eed.css" integrity="sha512-tKIbXT6x0KUSl&#43;MSMKZfwl44eEPkXsOi2Rds2NFjwhbZm5sTphiyj1N8O1WeyKQIGDsPv61I2t25vvp9PvkO7Q==" />








</head>

<body
  data-theme="auto"
  data-theme-auto='true'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://leeleelee3264.github.io/">leelee.log</a>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://leeleelee3264.github.io/post/2023-03-01-review-kasa/">[General] Kasa에서 백엔드 엔지니어로서의 1년 회고하기</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2023-02-24</span>

<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;7283 words</span>

<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/general">General</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <br>
<br> 
<blockquote>
<p>Kasa에서 1년 동안 백엔드 엔지니어로서 지낸 시간을 회고합니다.</p>
</blockquote>
<br> 
<p><strong>Index</strong></p>
<ol>
<li>Intro: 네? 회사가 매각된다구요? 그런데 부분 매각이라구요?</li>
<li>Work</li>
<li>Dev Culture</li>
</ol>
<br> 
<h1 id="intro-네-회사가-매각된다구요-그런데-부분-매각이라구요">Intro: 네? 회사가 매각된다구요? 그런데 부분 매각이라구요?</h1>
<h4 id="2021년-12월-싱가포르-사업을-위한-신생-팀에-입사하다">2021년 12월, 싱가포르 사업을 위한 신생 팀에 입사하다!</h4>
<p>2021년 12월 카사에 백엔드 엔지니어로 입사했다. 회사에서 막 싱가포르로 사업을 확장하기 시작했을 때였다.
회사에 입사한 계기는 2가지였다. 하나는 <code>싱가포르</code>를 대상으로 한 <code>글로벌 사업</code>을 경험해 볼 수 있다는 것이었다. 항상 글로벌 사업을 경험하고 싶었고, 때문에 전직장에서는 글로벌 사업을
철수해서 이직을 결심하기도 했다.</p>
<p>또 다른 계기는 <code>부동산 조각 투자</code>라는 <code>프롭테크 도메인</code>을 경험해 볼 수 있다는 것이었다. 언젠가 한 번 프롭테크 도메인을 경험하고 싶었는데
일반 부동산이 아닌, 부동산을 조각내서 투자한다는 사업이 굉장히 흥미롭게 다가왔다.
<U>싱가포르 버전의 프로덕트를 만들어 내는 것이 입사한 팀의 역할이다.</U></p>
<details>
 <summary>부동산 조각 투자 도메인?</summary>
<p>건물을 하나 선택해 공모를 진행하면 사용자가 청약을 하고, 회사는 청약금을 모아 <code>한국투자신탁</code>을 통해 <code>DABS</code>라고 불리는 디지털 수익 증권을 발행해 사용자에게 분배한다. 그 후, 사용자는 DABS를 주식을 거래하듯 다른 <code>사용자들과 거래</code>를 할 수 있다.</p>
<p>협력사인 <code>하나은행</code>과 연결해 계좌를 계설하고 예치금을 입금/출금할 수 있어 <code>뱅킹 도메인</code>도 경험을 할 수 있고 DABS 거래가 있어 <code>Trading-Matching 도메인</code>도 경험을 할 수 있다.</p>
</details>
<br>
<h4 id="2023년-01월-카사-매각-소식을-듣다">2023년 01월, 카사 매각 소식을 듣다!</h4>
<p>2023년 01월에 카사 매각 소식을 접하게 되었다.
부분 매각이었고, 매각의 대상은 코리아 프로덕트 팀이었다. 싱가포르 프로덕트 팀은 남아있는 것으로 결정되었다.<br>
<code>60명</code> 남짓했던 회사는 <code>10명</code>으로 규모가 줄었고, 규모가 줄어든 만큼 남은 인원들이 기존 인원들이 담당해왔던 업무들을 많이 가져와야 했다. 그 중 나는 <code>인프라 업무</code>를 서포트하게 되었다.
<code>DevOps</code> 업무를 하게 된 것이다!</p>
<p>DevOps 업무를 해보고 싶었기 때문에 염려도 되는 한 편, <U>새로운 업무를 하기 전에 1년 동안 내가 해왔던 일들을 회고해 둘 필요가 있음을 느꼈다.</U>
길고 장황한 Intro였지만, 결국 이 이유로 회고를 작성하게 되었다.</p>
<br>
<h1 id="work">Work</h1>
<h2 id="jwt를-이용한-token-authentication-개발">JWT를 이용한 Token Authentication 개발</h2>
<p>FE가 API를 호출할 때 토큰 기반으로 인증을 할 수 있도록 <code>JWT</code>를 이용해 <code>Token Authentication</code>을 개발했다. 평소 요청은 <code>access token</code> 으로 하고, 만료되면 <code>refresh token</code>을 사용해 새로운 access token을
발급하는 구조를 선택했다. <code>Django rest framework의 simplejwt</code> 라이브러리를 사용해서 <code>토큰 생성</code>, <code>revoke</code>, <code>refresh</code>를 구현했다.</p>
<p>회사에서는 3단계의 로그인 절차가 필요하다. <code>ID/PW 로그인</code>, <code>OTP 로그인</code>, <code>투자 계좌 로그인</code>의 절차로, 투자 계좌 로그인까지 해야 정식으로 서비스를 사용할 수 있다.
단계마다 토큰을 발급했다.</p>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/token.png" >
<figcaption align = "center">[Picture 1] Token Authentication 흐름</figcaption>
<br>
<p>처음에는 토큰의 유효 기간이나 폐기등의 토큰 정책을 유념하지 않았다. 하지만 <code>싱가포르 금융감독기관</code>의 인증인 <code>MAS Regulation</code>을 준수하기 위해랙 <code>서버 보안 강화</code>해야 했고, 토큰 정책도 포함이 되어있었다.</p>
<h4 id="토큰-보안-강화">토큰 보안 강화</h4>
<p>access의 만료시간은 <code>10분</code>, refresh의 만료시간은 <code>12시간</code>이었는데, refresh의 만료시간이 너무 길어, access token을 재발급 받을 때마다 refresh token도 재발급하는 <code>ROTATE_REFRESH_TOKENS</code>을 적용해 <U>refresh token의 수명을 10분으로 줄였다.</U></p>
<p>조사 결과 <code>링크드인</code>의 accsss 만료시간은 1일, refresh 만료시간은 6일이었고, <code>구글 클라우드</code>의 access 만료시간은 30분, refresh는 200일이었다.
refresh 수명이 짧아지면, 사용자가 활동이 없을 때 쉽게 로그아웃 되는 단점이 있지만, 앱이 아닌 <code>웹 서비스</code>이고, 싱가포르 금융 규제상 비교적 짧은 token 수명을 가지게 되었다.</p>
<p>또한 기존 refresh token을 내부 DB에서 <code>블랙리스트로 등록</code>하고, access token은 10분이 지나기 전에 새로 발급받으면 기존의 access token을 사용할 수 있기 때문에 <code>Redis 캐시</code>에 폐기된 access token을 관리하고 주기적으로 데이터를 지워주며 토큰의 보안을 강화했다.</p>
<p>토큰 구조는 Statue를 관리하지 않아 편리하지만 <U>만료가 되기 전까지는 사용이 가능하기 때문에 폐기 정책을 까다롭게 관리</U>해야 한다.</p>
<br>
<h2 id="api-접근제한을-위한-permission-개발">API 접근제한을 위한 Permission 개발</h2>
<p><code>TokenAuthentication</code>으로 토큰 인증이 끝이 나면 유저에 대한 식별이 가능하다.
BE API는 <code>사용자</code>와 <code>운영자</code> 전용 API를 모두 포함하고 있다. 더 나아가 사용자가 3단 로그인을 하며, 운영자 또한 공모 운영자, 회원관리 운영자 등으로 나눠져있기 때문에 <code>Role-based access control (RBAC)</code> 정책을 채택했다.</p>
<p>Django rest framework의 <code>Permission System</code>을 확장해서 요구사항에 맞는 확장된 커스텀 Permission을 만들었다. 이렇게 만들어진 Permission은 각 API View에 <code>permission_classes</code>을 설정해 API 접근 관리를 했다.</p>
<p>기존에는 아예 운영자용, 사용자용 API 서버를 따로 두었기 때문에 접근 권한을 까다롭게 고민하지 못하고, <code>Authentication</code>에만 집중을 했는데 이번 기회로 <code>Authorization</code>의 구조도 구축하는 할 수 있었다.</p>
<br>
<h2 id="offering-모듈-요구사항-분석">Offering 모듈 요구사항 분석</h2>
<p>부동산 조각 투자의 코어인 <code>건물</code>, <code>공모/청약</code>, <code>DABS 할당/발행</code>을 담당하는 Offering 모듈의 요구사항을 분석하게 되었다.
원래 Offering 기획을 하신 분이 내가 입사를 하기 전에 이미 퇴사를 하신 상태였고, 새로운 기획 담당자들과 함께 기획사항을 분석했다. 기획은 모두 싱가폴에 상주하고 있는 실무자들이 하기 때문에 문서 작성, 회의 등은 모두 <code>영어</code>로 이루어졌고,
팀에 공유를 하기 위해 다시 한국어로 번역을 하는 식으로 진행했다.</p>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/qna.png" >
<figcaption align = "center">[Picture 2] 질문 예시</figcaption>
<br>
<p>핵심 모듈의 요구사항을 잘못 분석한 상태로 개발에 들어가면 수정할 사항이 겉잡을 수 없을 만큼 커지고, 팀의 시간을 낭비하는 것이기 때문에 하나라도 놓치지 않겠다는 마음으로 임했다.
작업 초기에는 이 도메인이 처음인 내가 이해하기에 조금 어려웠으나 방대한 요구사항을 심층 분석하면서 회사의 도메인을 깊게 파악할 수 있는 기회였다.</p>
<p>이 작업을 하면서 개발자는 코딩만 잘하면 되는 것이 아니라 <U>요구사항을 파고 들어 분석을 해야 하며, 분석 과정에서 기획자나 다른 실무진들과 원활하면서도 긴밀하게 소통을 하기 위해 노력해야 한다는 것을 배웠다.</U></p>
<p>분석을 하면서 <code>총 160개의 질문</code>을 작성하며 <code>잘 질문하는 방법</code>에 대해서 어떻게 해야 내가 모르는 부분을 정확이 질문하는지 많이 고민했다.</p>
<br>
<h2 id="offering-모듈-api-명세-작성">Offering 모듈 API 명세 작성</h2>
<p>요구사항을 토대로 <U>요구사항들을 충족하기 위해 어떤 API가 호출이 되어야 하는지 명세를 작성했다.</U>
이 API 명세를 바탕으로 나를 포함한 백엔드 팀에서 실제 개발에 들어가기 때문에 누락된 요구사항은 없는지, 요구사항과 불일치 하는 것은 없는지 검토를 해야 했다.</p>
<p>회사 도메인에서 가장 핵심이 되는 모듈이었고, 이에 따라 요구사항도 다각화 되어있어 API 명세 정립도 쉽지 않았다.
하지만 셀장님, 팀원분들 그리고 프론트엔드 담당자분과 여러 번의 컨펌 끝에 총 <code>113개의 API 명세</code> 완성할 수 있었다.</p>
<br>
<blockquote>
<p>API 명세 Case</p>
</blockquote>
<ul>
<li>Issuer (건물주) 관리
<ul>
<li>Issuer 온보딩</li>
<li>Issuer 승인</li>
</ul>
</li>
<li>Deal 관리
<ul>
<li>Deal 등록</li>
<li>Deal 공개</li>
<li>Deal 정보 수정</li>
</ul>
</li>
<li>공모/청약
<ul>
<li>청약 신청/취소</li>
<li>공모 종료</li>
<li>DABS 확인</li>
</ul>
</li>
</ul>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/script.png" >
<figcaption align = "center">[Picture 3] API 명세 예시</figcaption>
<br>
<h2 id="싱가포르-정부-mydata-api인-myinfo-서비스-연결">싱가포르 정부 Mydata API인 Myinfo 서비스 연결</h2>
<p><code>Myinfo</code>는 2017년부터 정부 주도하에 디지털화된 신원확인 체계를 수립하려는 <code>NDI</code> (National Digital Identity) 프로젝트의 일부이다.
<U>카사 싱가포르는 자산이 10억 이상일때만 회원가입을 할 수 있는데</U> 이를 증명하기 위한 통장 잔액, 세금 내역서 등의 <code>증명서류</code>를 까다롭게 요구할 수 밖에 없었고, 이는 <code>온보딩의 병목</code>이 되었다.</p>
<p>때문에 Finance를 포함한 싱가포르 국민의 모든 데이터를 제공하는 Myinfo 서비스를 도입하게 되었다. Myinfo의 데이터는 정부가 제공하는 리소스이기 때문에 믿을 수 있었고, 사용자도 증명서류 없이 데이터를 불러오기만 하면
되니 <code>온보딩 이탈률을 50% 가까이 줄일 수 있었다</code>.</p>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/req_one.png" >
<figcaption align = "center">[Picture 4] Myinfo Requirements</figcaption>
<br>
<p>정부의 사업이다보니 API Key 와 Secret을 발급받으면 API를 사용할 수 있는 기존의 API 서비스와는 다르게 조건 사항이 많았다.
3, 4, 5 항목은 크게 문제가 없었지만 <code>Transaction Log</code>와 <code>X.509 Public Key</code> 부분이 까다로웠다.</p>
<br>
<blockquote>
<p>Transaction Log</p>
</blockquote>
<p>기존에 로그를 <code>AWS Opensearch</code>로 남기고, <code>AWS Opensearch Dashboard</code>로 보고 있던 터라, 동일한 방식으로 로그를 남겼다.</p>
<p>Myinfo에서 가져오는 데이터를 로깅해야 했는데 여기에는 <code>NRIC</code>(싱가포르 주민번호)와 이름 등의 개인정보가 포함이 되어있었다. 당시에 코리아 프로덕트가 <code>ISMS</code> 심사를 준비하고 있었기 때문에
싱가포르 프로덕트 또한 ISMS 규정에 맞춰 <U>개인 식별 정보인 NRIC를 암호화 해서 로그를 남겨야 했다.</U></p>
<p>암호화 뿐 만 아니라,  암호화 키 또한 주기적으로 변경해야 했다. 따라서 <code>AWS KMS</code> 서비스를 사용해서 개인 식별 정보를 암호화하고, <code>스케쥴러</code>로 주기적으로 기존 암호화 키를 폐기하고 새로운 암호화 키를 발급받았다.</p>
<br>
<blockquote>
<p>X.509 Public Key</p>
</blockquote>
<p>Myinfo 서버에 데이터를 요청하고, 받기 위해서는 모든 요청과 데이터를 암호화하는 <code>PKI 구조</code>를 취해야 했다.</p>
<h5 id="pki-사용-시나리오">PKI 사용 시나리오</h5>
<p>Myinfo로 보내는 요청이 Kasa에서 온 것임을 확인하기 위해 Kasa의 <code>Private key</code>로 서명을 해야 했고, Myinfod에 Kasa의 Private key로 만든 <code>X.509 인증서</code>, 즉 <code>Public key</code>를 제출해야 했다.</p>
<p>또한 Myinfo에서 온 데이터를 확인할 때는 이 응답이 Myinfo에서 온 것을 확인하기 위해 Myinfo에서 발급해준 Myinfo Public key로 <code>verify</code>를 하고, 한 번 더 Kasa의 Private key로 <code>decrypt</code>를 해야 했다.</p>
<br>
<img class="img-zoomabㅅle medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/req_two.png" >
<figcaption align = "center">[Picture 5] Myinfo에서 허가하는 Root CA</figcaption>
<br>
<p>Myinfo에서 허가하는 <code>Root CA</code>가 별도로 있기 때문에 <code>digicert</code>와 <code>netrust</code>에 하나 하나 직접 문의를 하다가 결국 netrust에서 발급을 했다.</p>
<p>인증서 자체에 대한 지식이 전무했고 비용과 싱가포르 정부의 기업 인증 등 많은 어려움에 봉착했다. 또한 <U>경영팀, 인프라 팀과 정보보안 팀의 그레이존에 있는 부분이 많았지만 팀의 업무를 가리지 않고 모두 담당을 하니 많은 것을 배울 수 있었고,</U>
실제로 Kasa에서 했던 <code>가장 보람있는 프로젝트</code> 였다.</p>
<br>
<p>프로젝트를 하면서 공부했던 포스팅은 아래에서 확인이 가능하다.</p>
<ul>
<li><a href="https://leeleelee3264.github.io/post/2022-06-15-digital-certificate-part-one/" target="_blank">[[Infra] 네트워크 필수교양, 인증서 (1/2) - 쌩기초]</a></li>
<li><a href="https://leeleelee3264.github.io/post/2022-08-27-digital-certificate-part-final/" target="_blank">[[Infra] 네트워크 필수교양, 인증서 (2/2) - 심화학습]</a></li>
<li><a href="https://leeleelee3264.github.io/post/2022-07-23-project-myinfo-connector-python/" target="_blank">[[Project] Django로 Myinfo oauth2 클라이언트 만들기]</a></li>
</ul>
<br>
<h2 id="공모-청산-모듈-개발">공모 청산 모듈 개발</h2>
<p>공모가 끝나고 청약을 신청한 사용자들의 공모금을 Custody에 이체하고, 청약 금액만큼의 DABS를 할당/발행하는 모듈을 개발했다.</p>
<h5 id="custody">Custody?</h5>
<p>여기서 <code>Custody</code>란 <code>디지털 자산 수탁자</code>로, 디지털화된 자산을 보관하는 서비스이다. 싱가포르에서는 디지털 자산을 직접적으로 보관할 수 있는 라이센스가 없다면 Custody 서비스를 통해 자산을 보관해야 한다.
따라서 예치금을 관리하는 <code>예치금 계좌</code>도, DABS를 보유하는 <code>DABS 계좌</code>도 Custody를 사용하여 관리가 된다.</p>
<br>
<h4 id="공모-종료와-dabs-할당량-계산">공모 종료와 DABS 할당량 계산</h4>
<p>공모를 종료하는 날이 오면 공모에 청약한 투자자들에게 분배가 될 <code>DABS 할당량</code>을 계산한다. 계산 방식은 청약 금액과 DABS 수를 비례하여 나누어 배정하는 <code>안분비례</code> 방식이다. 안분비례에서는 안분비율의 <code>소수점을 몇 자리 까지 유지</code>할 것인지가 중요하다. 부동산 자산이 대상이기 떄문에 처음의 공모금액 자체가 클 것 같아서 15자리까지 유지를 했고, <code>Decimal</code>로 관리를 했다.</p>
<p>구현상 고민을 했던 점은 안분비례를 적용하면 <U>신청된 청약을 모두 탐색해야 한다는 점이었다.</U> 두 번의 계산이 들어가는데 처음은 전체의 안분 비율을 구해서 청약한 DABS 만큼 곱해서 주면 되었다.
이렇게 하면 남는 DABS가 발생하고 정수부는 빼고, 소수부가 큰 순서대로 남는 DABS를 추가 할당한다.</p>
<p><code>청약 데이터</code>가 DB에서 한 투자자당 하나의 row로 관리되는 것이 아닌, 청약을 할 떄마다 row가 쌓이는 <code>Log structed</code> 형태라 꽤 많은 데이터를 가져와 안분비례 공정을 해야 했다.
정말 청약이 몰려서 10만건 정도 된다면 그 청약 데이터를 메모리에 모두 올리면 <code>Out of Memory</code>가 날 수 도 있다고 생각했다. 때문에 Python에서 제공하는 <code>yield</code> 기능을 사용해서 청약 데이터를 100건씩 끊어서 가져와 결과를 누적하는 식으로 연산을 했다.</p>
<br>
<h4 id="공모금-이체와-dabs-할당">공모금 이체와 DABS 할당</h4>
<p>DABS를 할당하는 날이 오면  할당이 이뤄지고, <code>공모금</code>을 Custody의 <code>건물 판매자 계좌</code>에 이체해야 한다. 모아진 공모금으로 건물을 사기 때문이다.
DABS 할당부터는 <code>Custody</code>, <code>블록체인</code>과 많은 소통을 해야 한다. 디지털 자산이 오고 가기 때문에 Custody를 통해야 하고, 블록체인에 디지털 자산의 모든 변경 내역을 기록해야 한다.</p>
<p>미할당 공모금에 대해 <code>환불</code>이 이뤄진 후에 공모금을 <code>이체</code>한다. 이때 각 투자자의 예치금 계좌에서 돈이 나가도록 Custody를 호출하고, 내부 블록체인을 호출한다. 공모금이 모두 이체가 되기 전까지는 실제 DABS를 발행하지 못했다가 이체 완료가 되면 DABS를 발행할 수 있도록 Custody에 <code>Mint</code>를 요청한다.</p>
<p>실제 고객의 계좌에서 큰 액수의 돈이 빠져나가고, 외부의 API들을 호출하면서 길고 복잡한 흐름을 가지고 있다 보니 각 단계에서 일어날 수 있는 <code>예외 상황</code>과 이에 대한 <code>대처 방법</code>을 많이 고민했다.
중간에 실패하더라도 이전의 이체 내역이 Rollback 되지 않도록 <code>Durability</code>를 살리도록 고려하여 <code>트랜잭션</code>의 단위를 묶었다. 또한 단계 별로 <code>재시도</code>를 하는 방안을 구현했다.</p>
<p>이때 API 서버가 실제로는 여러 개 띄워져있는 <code>멀티파드</code>의 환경이기 때문에 <code>Race Condition</code>을 방지하도록 Django ORM의 <code>select_for_update</code> 방식을 채택했다.</p>
<br>
<h4 id="dabs-발행">DABS 발행</h4>
<p>DABS를 발행하는 것이 공모의 마지막 흐름이다. DABS를 투자자들의 <code>DABS 계좌</code>에 실제로 입고해주는 것인데 이 또한 디지털 자산이 오고 가기 떄문에 Custody와 Blockchain과 소통이 필요하다.
<U>중요한 것은 DABS 분배 요청을 Custody에 보내고, 이 모든 요청을 Custody가 callback으로 승인을 해줘야 실제 분배된 것으로 인정되어 DB에 쓰이고 블록체인에 기록할 수 있다는 점이다.</U></p>
<p>처음에는 내부에 기록을 한 다음에 Custody에 마지막으로 승인 요청을 보냈는데 이럴 경우 싱가포르의 디지털 자산 관리 법에 걸리기 때문에 코드에 많은 수정을 해야 할 수 도 있었다.
하지만 첫 구현에서 <code>함수를 최대한 분리</code>하고, 이 함수를 <code>추상화</code> 했기 때문에 함수를 호출하는 외부는 아무런 변경이 필요 없었고, 함수 내부 또한 내부 함수의 호출 순서 정도를 바꾸는 것으로 수정을 했다.</p>
<p>프러덕트 팀에서는 법적인 사항으로 <code>런칭에 병목이 걸릴 거라 예상</code>했지만 1시간도 안 걸려 수정하고 배포까지 끝냈기 떄문에 런칭 일정에 차질이 생기지 않았다. 이 경험으로 초기에 구현을 할 떄 왜 많은 개발자들이 유지보수에 용이하도록 읽기 쉬운 코드를 짜고, 추상화를 하라고 했는지 몸소 이해할 수 있었다.</p>
<br>
<h2 id="대사-모듈-개발">대사 모듈 개발</h2>
<p>서비스에서 사용되는 <U>예치금 계좌와 DABS 계좌는 회사의 DB 말고도 회사의 블록체인과 Custody에서도 관리가 되고 있다.</U> 때문에 셋의 계좌들 데이터가 동일한 것을 확인해야 하고, 동일하지 않다면 로그를 모두 탐색해서 긴급하게 조치를 취해야한다.
따라서 매일 오후 10시에 DB, 블록체인, Custody 사이의 <code>대사(reconciliation)</code>를 맞추는 모듈을 개발했다.</p>
<br>
<blockquote>
<p>대사의 대상</p>
</blockquote>
<ul>
<li><code>DB</code> 예치금 계좌 &lt;-&gt; <code>블록체인</code> 예치금 계좌</li>
<li><code>DB</code> DABS 계좌 &lt;-&gt; <code>블록체인</code> DABS 계좌</li>
<li><code>DB</code> 예치금 계좌 &lt;-&gt; <code>Custody</code> 예치금 계좌</li>
<li><code>DB</code> DABS 계좌 &lt;-&gt; <code>Custody</code> DABS 계좌</li>
</ul>
<br>
<p>사용되는 데이터의 리소스는 다르지만 과정은 모두 동일하기 때문에 어떻게 <code>추상화</code>를 해서 <code>통일된 구조</code>를 가져갈 수 있을지 고민을 많이 했다.
또한 구현 보다는 <code>비즈니스 로직</code>과 <code>서비스의 정책</code>을 섬세하게 이해하는 과정이 필요했다. 예를 들어 오후 6시에 장이 마감되면 거래가 안 된 DABS가 원래 계좌로 돌아가는 것이나, 예치금 입금이 pending 상태면 Custody에서는 없는 금액으로 취급하는 것 등.</p>
<p>때문에 개발을 하면서 점점 이해가 깊어지면서 수정 작업을 10번도 넘게 진행했다. ₩ 정도가 개발 볼륨에 얼마나 영향을 미치는지 다시 한 번 생각했고, 정책을 더 꼼꼼하게 파악하는 태도를 늘 내제해야 할 필요를 느꼈다.</p>
<br>
<h2 id="notification-모듈-개발">Notification 모듈 개발</h2>
<p>공모 오픈 소식이나 DABS 할당, Trading 내역 등 다양한 자산 관련 Notification을 투자자에게 제공하는 Notification 모듈을 개발했다.
Notification 발생 소식을 투자자의 이메일로 알리고, 매직 링크를 타고 홈페이지에 들어오면 해당 Notification을 Pdf로 다운 받을 수 있는 형태였다.</p>
<p>서버에 있는 템플릿에 DB에서 가져온 컨텍스트를 채워서 pdf를 생성하기 때문에 <code>HTML</code>과 <code>css</code>를 사용해서 템플릿을 구현했다. 개중 API에서 일으키는 DB의 변경에 의해 Notification을 발송해야 하는 부분이 있어
<code>Spring의 Event handler</code>와 유사한 <code>Django의 signal</code> 기능을 사용했다.</p>
<br>
<h1 id="dev-culture">Dev Culture</h1>
<h2 id="사내-스터디-리드">사내 스터디 리드</h2>
<p>전 직장에서 스터디를 했던 게 너무 재미있어서 이번에도 사내 스터디를 조직했다. 토이 프로젝트나 회사 기술 블로그를 만들고 싶었지만 일정이 여의치 않아 책 스터디로 진행했다.
특히 HTTP 완벽 가이드는 쌩신입일때 추천받아 읽은 책인데 3년 정도 후에 다시 읽어보니 이해할 수 있는 폭이 넓어져있어서 뿌듯했다.</p>
<br>
<blockquote>
<p>진행한 책</p>
</blockquote>
<ul>
<li>HTTP 완벽 가이드</li>
<li>하이퍼레저 패브릭으로 배우는 블록체인</li>
<li>Kotlin in Action</li>
</ul>
<br>
<blockquote>
<p>진행 방법</p>
</blockquote>
<ul>
<li>준비
<ul>
<li>주차별로 정해진 분량 독서 (<a href="https://brunch.co.kr/@libraryman/46" target="_blank">3색 독서법</a>)</li>
<li>참가자 모두가 주차별로 할당된 주제에 대해 발표 준비</li>
</ul>
</li>
<li>스터디
<ul>
<li>발표</li>
<li>토론/회고 (좋았던 내용, 고민, 어려움, 더 찾아본 부분 공유)</li>
</ul>
</li>
<li>참고
<ul>
<li><a href="https://puffy-stick-fa1.notion.site/2022-ca5f43fc259d446d81f376256d18b99b" target="_blank">2022 우아한 스터디</a></li>
</ul>
</li>
</ul>
<br>
<h2 id="django에서-동시성을-다루는-방법-세미나-진행">Django에서 동시성을 다루는 방법 세미나 진행</h2>
<p>2022년 11월에 <code>Django에서 동시성을 다루는 방법</code> 이라는 제목으로 세미나를 진행했다.
Django로 백엔드 서버를 다루면서 마주했던 <code>동시성</code> 관련 이슈를 트러블 슈팅하면서 배운 점을 정리해 사내의 개발자들과 함께 공유하는 시간을 가졌다.</p>
<br>
<blockquote>
<p>세미나에서 다룬 것</p>
</blockquote>
<ul>
<li>API 요청을 <code>Serialize</code> 하는 방법
<ul>
<li>Request를 하나의 큐에 모아 Serialize 하게 처리</li>
<li>DB의 Transaction을 Serialize 하게 처리</li>
</ul>
</li>
<li>Django Transaction <code>Atomicity</code>
<ul>
<li>Django ORM: select_for_update</li>
<li>Django ORM: Atomic compare-and-swaps</li>
<li>Redis Lock</li>
</ul>
</li>
<li>Django Transaction Test &amp; <code>Durability</code></li>
</ul>
<br>
<p>세미나 영상과 발표 자료, 회고는 <a href="https://leeleelee3264.github.io/post/2022-12-26-kasa-concurrency-seminar/" target="_blank">[[Seminar] Django에서 동시성을 다루는 방법으로 인생 첫 세미나 진행하기]</a> 에서 더 자세하게 다루고 있다.</p>
<br>
<h2 id="nhn-forward-2022-참석">NHN Forward 2022 참석</h2>
<p>NHN Forward 2022는 처음으로 참석한 오프라인 개발자 컨퍼런스다.
듣고 싶은 세션이 너무 많아 하루 종일 빡빡한 스케쥴로 파르나스 여기저기를 옮겨다녔다. 참여한 기업 부스가 많아서 참석 경품을 정말 한 바가지 받아서 컨퍼런스에 참여하지 못한 동료들에게 나눠주는 등 즐거운 시간이었다.</p>
<p>앞으로는 컨퍼런스에 <U>참석으로 그치는 것이 아닌 현장에서 열심히 듣고, 집에 와서 모르는 내용을 찾아보고 정리해야 할 필요를 느꼈다.</U> 그리고 시간이 넉넉하더라도 꼭 일찍 등록을 하고, 세미나실에도 미리 들어가서 자리를 확보 해야겠다!</p>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/nhn.jpeg" >
<figcaption align = "center">[Picture 6] NHN Forward 초대창</figcaption>
<br>
<h2 id="naver-deview-2023-참석">Naver Deview 2023 참석</h2>
<p>2023년 02월에 Naver 개발자 컨퍼런스인 Deview 2023에 참석했다.</p>
<p>급하게 회사로 복귀해야 해서 세션은 하나 밖에 듣지 못했지만 부스가 알찼다. 특히 <code>네이버 클로바</code>와 <code>네이버 제트</code>의 개발팀에게 직접
사내 개발 문화와 분위기, 필수로 요구되는 스킬 등을 질문하고 그 분들의 답변을 들을 수 있어서 좋았다.</p>
<p>특히 네이버 제트에 계신 분이 해주신 답변이 인상 깊었다.
단순히 기술을 도입하는 것이 아니라 <U>왜 이 기술을 도입해야 하며, 이 기술을 통해 해결할 수 있는 것이 무엇인지</U>를 고민하며 사내의 기술 스텍을 쌓아간다는 말씀이 좋았다.
내가 도입하고 싶어하는 기술이 정말 이 Use Case에 적합해서인지, 아니면 지금 인기가 많은 기술이라 그런지 가끔씩 의구심이 들었는데 정곡을 찔린 느낌이었다.</p>
<br>
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/IMG_5553.JPG" >
<figcaption align = "center">[Picture 7] Deview 포토존</figcaption>
<br> 
<img class="img-zoomable medium-zoom-image __web-inspector-hide-shortcut__" src="/static/img/post/kasa/IMG_5563.JPG" >
<figcaption align = "center">[Picture 8] Deview 입장 팔찌</figcaption>
<br> 
    </div>
</article>



<div class="post-comment" data-comment="utterances">
    <span class="post-comment-notloaded">
        <i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments
    </span>
    <script>
        function loadComment() {
            var commentArea = document.querySelector('.post-comment');
            var utterancesTheme = document.body.getAttribute('data-theme');
            if (utterancesTheme === 'auto') {
                utterancesTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'photon-dark' :
                    'github-light';
            } else {
                utterancesTheme = utterancesTheme === 'dark' ? 'photon-dark' : 'github-light';
            }
            var s = document.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'leeleelee3264\/github_io_comment');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('theme', utterancesTheme);
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('async', '');
            document.querySelector('.post-comment').appendChild(s);
            document.querySelector('span.post-comment-notloaded').setAttribute('style', 'display: none;');
        }
    </script>
</div>


            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/leeleelee3264" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/seungmin4035/" target="_blank"><span>LinkedIn</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/backend/">Backend</a>
            </span>
            
            <span>
                <a href="/tags/book/">Book</a>
            </span>
            
            <span>
                <a href="/tags/cheat/">Cheat</a>
            </span>
            
            <span>
                <a href="/tags/frontend/">Frontend</a>
            </span>
            
            <span>
                <a href="/tags/general/">General</a>
            </span>
            
            <span>
                <a href="/tags/infra/">Infra</a>
            </span>
            
            <span>
                <a href="/tags/project/">Project</a>
            </span>
            
        </div>
    </div>
    
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/leeleelee3264" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/seungmin4035/" target="_blank"><span>LinkedIn</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/backend/">Backend</a>
            </span>
            
            <span>
                <a href="/tags/book/">Book</a>
            </span>
            
            <span>
                <a href="/tags/cheat/">Cheat</a>
            </span>
            
            <span>
                <a href="/tags/frontend/">Frontend</a>
            </span>
            
            <span>
                <a href="/tags/general/">General</a>
            </span>
            
            <span>
                <a href="/tags/infra/">Infra</a>
            </span>
            
            <span>
                <a href="/tags/project/">Project</a>
            </span>
            
        </div>
    </div>
    
    
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2020-2023
                <a href="https://leeleelee3264.github.io/">leeleelee3264</a>
                 | <a href="https://github.com/leeleelee3264/leeleelee3264.github.io">Source code</a> 
                | Powered by <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js" integrity="sha512-LCKPTo0gtJ74zCNMbWw04ltmujpzSR4oW+fgN+Y1YclhM5ZrHCZQAJE4quEodcI/G122sRhSGU2BsSRUZ2Gu3w==" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-GP4x8UWxWyh4BMbyJGOGneiTbkrWEF5izsVJByzVLodP8CuJH/n936+yQDMJJrOPUHLgyPbLiGw2rXmdvGdXHA==" crossorigin="anonymous"></script>



<script defer src="/assets/js/fuji.min.645f1123be695831f419ab54c1bcba327325895c740014006e57070d4f3e5d6b553e929c4b46f40ea707249e9c7f7c2a446d32a39ce7319f80a34525586a8e0f.js" integrity="sha512-ZF8RI75pWDH0GatUwby6MnMliVx0ABQAblcHDU8&#43;XWtVPpKcS0b0DqcHJJ6cf3wqRG0yo5znMZ&#43;Ao0UlWGqODw=="></script>



</body>

</html>
